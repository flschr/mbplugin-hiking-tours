{{- /* Minimal tour shortcode */ -}}
{{- $id := .Get "id" -}}
{{- $title := .Get "title" -}}
{{- $type := .Get "type" -}}
{{- $region := .Get "region" -}}
{{- $distanceKm := .Get "distance_km" -}}
{{- $elevationM := .Get "elevation_m" -}}
{{- $durationH := .Get "duration_h" -}}
{{- $maxHeight := .Get "max_height" -}}
{{- $gpx := .Get "gpx" -}}
{{- $coverImage := .Get "cover_image" -}}
{{- $bergfexUrl := .Get "bergfex_url" -}}
{{- $peaksRaw := .Get "peaks" -}}

{{- $isFeedOutput := false -}}
{{- with $.Page.OutputFormats -}}
  {{- range . -}}
    {{- $formatName := lower .Name -}}
    {{- if or (eq $formatName "rss") (eq $formatName "json") (eq $formatName "atom") -}}
      {{- $isFeedOutput = true -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $shouldRenderMap := and $gpx (ne $gpx "") -}}
{{- $peaksRawTrimmed := "" -}}
{{- if $peaksRaw -}}
  {{- $peaksRawTrimmed = trim $peaksRaw " \n\t;" -}}
{{- end -}}
{{- $hasPeaks := and $peaksRaw (ne $peaksRawTrimmed "") -}}
{{- $peaksList := slice -}}
{{- if $hasPeaks -}}
  {{- range $value := split $peaksRaw ";" -}}
    {{- $peak := trim $value " \n\t" -}}
    {{- if $peak -}}
      {{- $peakLabel := $peak -}}
      {{- $lat := "" -}}
      {{- $lng := "" -}}
      {{- if in $peak "|" -}}
        {{- $parts := split $peak "|" -}}
        {{- $peakLabel = trim (index $parts 0) " \n\t" -}}
        {{- if ge (len $parts) 3 -}}
          {{- $lat = trim (index $parts 1) " \n\t" -}}
          {{- $lng = trim (index $parts 2) " \n\t" -}}
        {{- end -}}
      {{- else if in $peak ":" -}}
        {{- $parts := split $peak ":" -}}
        {{- $name := trim (index $parts 0) " \n\t" -}}
        {{- $coordsPart := "" -}}
        {{- if ge (len $parts) 2 -}}
          {{- $coordsPart = trim (index $parts 1) " \n\t" -}}
        {{- end -}}
        {{- $metaParts := slice -}}
        {{- if ge (len $parts) 3 -}}
          {{- range $idx, $val := $parts -}}
            {{- if ge $idx 2 -}}
              {{- $metaParts = $metaParts | append (trim $val " \n\t") -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
        {{- $meta := delimit $metaParts ":" -}}
        {{- if $meta -}}
          {{- $peakLabel = trim (printf "%s %s" $name $meta) " \n\t" -}}
        {{- else -}}
          {{- $peakLabel = $name -}}
        {{- end -}}
        {{- $coordPieces := split $coordsPart "," -}}
        {{- if ge (len $coordPieces) 2 -}}
          {{- $lat = trim (index $coordPieces 0) " \n\t" -}}
          {{- $lng = trim (index $coordPieces 1) " \n\t" -}}
        {{- end -}}
      {{- else -}}
        {{- $peakLabel = trim $peak " \n\t" -}}
      {{- end -}}
      {{- $peakDict := dict "label" $peakLabel -}}
      {{- $hasCoords := and $lat (ne $lat "") $lng (ne $lng "") -}}
      {{- if $hasCoords -}}
        {{- $peakDict = merge $peakDict (dict "lat" $lat "lng" $lng) -}}
      {{- end -}}
      {{- $peaksList = $peaksList | append $peakDict -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- $peaksWithCoords := where $peaksList "lat" "ne" nil -}}
{{- $peaksDataJSON := "" -}}
{{- if gt (len $peaksWithCoords) 0 -}}
  {{- $peaksDataJSON = $peaksList | jsonify -}}
{{- end -}}

{{- $typeLabel := $type -}}
{{- if eq $type "hike" -}}
  {{- $typeLabel = "Hike" -}}
{{- else if eq $type "mtb" -}}
  {{- $typeLabel = "MTB" -}}
{{- else if eq $type "gravel" -}}
  {{- $typeLabel = "Gravel" -}}
{{- else if eq $type "run" -}}
  {{- $typeLabel = "Run" -}}
{{- end -}}

{{- if and (not $isFeedOutput) $shouldRenderMap -}}
  {{- if not ($.Page.Scratch.Get "tour-map-assets-loaded") -}}
    {{- $.Page.Scratch.Set "tour-map-assets-loaded" true -}}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha512-Zcn6bjR/8RZbLEpLIeOwNtzREBAJnUKESxces60Mpoj+2okopSAcSUIUOseddDm0cxnGQzxIR7vJgsLZbdLE3w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha512-BwHfrr4c9kmRkLw6iXFdzcdWV/PGkVgiIyIWLLlTSXzWQzxuSg4DiQUCpauz/EWjgk5TYQqX/kvn9pG1NpYfqg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-gpx@1.7.0/gpx.min.js" integrity="sha512-/yPV78iMZW2vseexUfxggYuVB4fzq40fsDVwz3tWOl9cb8MvCnmMCOjze1omsEj+APUuwZgnpcv5NR5q363JBA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="{{ "tours/tour-maps.js" | relURL }}" defer></script>
  {{- end -}}
{{- end -}}

{{- if and (not $isFeedOutput) (not ($.Page.Scratch.Get "tour-stats-styles")) -}}
  {{- $.Page.Scratch.Set "tour-stats-styles" true -}}
  <style>
    .tour-entry .tour-stats-grid {
      margin: 1.5rem auto 0;
      padding: 0;
      list-style: none;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 1rem;
      max-width: 720px;
    }

    .tour-entry .tour-stat-card {
      background: #f5f5f5;
      border-radius: 14px;
      padding: 1.15rem 1rem 1.25rem;
      text-align: center;
    }

    .tour-entry .tour-stat-card dt {
      margin: 0 0 0.35rem;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #666;
    }

    .tour-entry .tour-stat-card dd {
      margin: 0;
      font-weight: 600;
      color: #111;
    }

    .tour-entry .tour-stat-value {
      display: inline-block;
      font-size: clamp(1.8rem, 4vw, 2.3rem);
      line-height: 1;
      font-weight: 700;
    }

    .tour-entry .tour-stat-unit {
      margin-left: 0.25rem;
      font-size: 1rem;
      color: #666;
    }

    @media (min-width: 768px) {
      .tour-entry .tour-stats-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }
  </style>
{{- end -}}

{{- if $isFeedOutput -}}
<div>
  <strong>{{ $title | htmlEscape }}</strong>
  {{- if $typeLabel }} · {{ $typeLabel | htmlEscape }}{{ end -}}
  {{- if $region }} · {{ $region | htmlEscape }}{{ end -}}
  {{- if $distanceKm }} · {{ $distanceKm | htmlEscape }} km{{ end -}}
  {{- if $elevationM }} · {{ $elevationM | htmlEscape }} hm{{ end -}}
  {{- if $gpx }} · <a href="{{ $gpx | htmlEscape }}">GPX</a>{{ end -}}
</div>
{{- else -}}
<section class="tour-entry" id="tour-{{ $id | htmlEscape }}">
  <header>
    <p class="tour-entry-meta">
      {{- if $typeLabel -}}
      <span>{{ $typeLabel | htmlEscape }}</span>
      {{- end -}}
      {{- if and $typeLabel $region -}}
      <span aria-hidden="true">·</span>
      {{- end -}}
      {{- if $region -}}
      <span>{{ $region | htmlEscape }}</span>
      {{- end -}}
      {{- if $gpx -}}
      <span aria-hidden="true">·</span>
      <a href="{{ $gpx | htmlEscape }}" download>GPX</a>
      {{- end -}}
      {{- if $bergfexUrl -}}
      <span aria-hidden="true">·</span>
      <a href="{{ $bergfexUrl | htmlEscape }}">Bergfex</a>
      {{- end -}}
    </p>
    <h3>{{ $title | htmlEscape }}</h3>
  </header>

  {{- if $shouldRenderMap -}}
  <div class="tour-map" data-tour-map data-gpx="{{ $gpx | htmlEscape }}"{{ if $peaksDataJSON }} data-peaks='{{ $peaksDataJSON | safeHTMLAttr }}'{{ end }} style="min-height:320px; margin:1rem 0;"></div>
  {{- else if $coverImage -}}
  <figure class="tour-image">
    <img src="{{ $coverImage | htmlEscape }}" alt="{{ $title | htmlEscape }}" loading="lazy" />
  </figure>
  {{- end -}}

  <dl class="tour-stats-grid">
    {{- if $distanceKm -}}
    <div class="tour-stat-card">
      <dt>Distanz</dt>
      <dd>
        <span class="tour-stat-value">{{ $distanceKm | htmlEscape }}</span>
        <span class="tour-stat-unit">km</span>
      </dd>
    </div>
    {{- end -}}
    {{- if $elevationM -}}
    <div class="tour-stat-card">
      <dt>Aufstieg</dt>
      <dd>
        <span class="tour-stat-value">{{ $elevationM | htmlEscape }}</span>
        <span class="tour-stat-unit">m</span>
      </dd>
    </div>
    {{- end -}}
    {{- if $maxHeight -}}
    <div class="tour-stat-card">
      <dt>Max. Höhe</dt>
      <dd>
        <span class="tour-stat-value">{{ $maxHeight | htmlEscape }}</span>
        <span class="tour-stat-unit">m</span>
      </dd>
    </div>
    {{- end -}}
    {{- if $durationH -}}
    <div class="tour-stat-card">
      <dt>Dauer</dt>
      <dd>
        <span class="tour-stat-value">{{ $durationH | htmlEscape }}</span>
        <span class="tour-stat-unit">h</span>
      </dd>
    </div>
    {{- end -}}
  </dl>

  {{- if $hasPeaks -}}
  <section>
    <h4>Gipfelbuch</h4>
    <ol>
      {{- range $peaksList -}}
      <li>{{ .label | htmlEscape }}</li>
      {{- end -}}
    </ol>
  </section>
  {{- end -}}
</section>
{{- end -}}
