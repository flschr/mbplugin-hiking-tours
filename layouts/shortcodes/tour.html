{{- /* Minimal tour shortcode with improved validation and structure */ -}}
{{- $id := .Get "id" -}}
{{- $title := .Get "title" -}}
{{- $type := .Get "type" -}}
{{- $region := .Get "region" -}}
{{- $gpx := .Get "gpx" -}}
{{- $coverImage := .Get "cover_image" -}}
{{- $bergfexUrl := .Get "bergfex_url" -}}
{{- $peaksRaw := .Get "peaks" -}}

{{- /* Validate and parse numeric parameters with safe conversion */ -}}
{{- $distanceKm := 0.0 -}}
{{- with .Get "distance_km" -}}
  {{- $parsed := float . -}}
  {{- if and $parsed (gt $parsed 0) -}}
    {{- $distanceKm = $parsed -}}
  {{- end -}}
{{- end -}}

{{- $elevationM := 0.0 -}}
{{- with .Get "elevation_m" -}}
  {{- $parsed := float . -}}
  {{- if and $parsed (gt $parsed 0) -}}
    {{- $elevationM = $parsed -}}
  {{- end -}}
{{- end -}}

{{- $durationH := 0.0 -}}
{{- with .Get "duration_h" -}}
  {{- $parsed := float . -}}
  {{- if and $parsed (gt $parsed 0) -}}
    {{- $durationH = $parsed -}}
  {{- end -}}
{{- end -}}

{{- $maxHeight := 0.0 -}}
{{- with .Get "max_height" -}}
  {{- $parsed := float . -}}
  {{- if and $parsed (gt $parsed 0) -}}
    {{- $maxHeight = $parsed -}}
  {{- end -}}
{{- end -}}

{{- /* Detect feed output formats */ -}}
{{- $isFeedOutput := false -}}
{{- with $.Page.OutputFormats -}}
  {{- range . -}}
    {{- $formatName := lower .Name -}}
    {{- if or (eq $formatName "rss") (eq $formatName "json") (eq $formatName "atom") -}}
      {{- $isFeedOutput = true -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* Parse peaks using partial */ -}}
{{- $peaksData := partial "tour-parse-peaks.html" (dict "peaksRaw" $peaksRaw) -}}
{{- $peaksList := $peaksData.peaksList -}}
{{- $peaksWithCoords := $peaksData.peaksWithCoords -}}
{{- $peaksDataJSON := $peaksData.peaksDataJSON -}}
{{- $hasPeaks := gt (len $peaksList) 0 -}}

{{- /* Map rendering logic */ -}}
{{- $shouldRenderMap := and $gpx (ne $gpx "") -}}

{{- /* Type label mapping */ -}}
{{- $typeLabel := $type -}}
{{- if eq $type "hike" -}}
  {{- $typeLabel = "Hike" -}}
{{- else if eq $type "mtb" -}}
  {{- $typeLabel = "MTB" -}}
{{- else if eq $type "gravel" -}}
  {{- $typeLabel = "Gravel" -}}
{{- else if eq $type "run" -}}
  {{- $typeLabel = "Run" -}}
{{- end -}}

{{- /* Load assets once per page (not per shortcode) */ -}}
{{- if and (not $isFeedOutput) $shouldRenderMap -}}
  {{- if not ($.Page.Scratch.Get "tour-map-assets-loaded") -}}
    {{- $.Page.Scratch.Set "tour-map-assets-loaded" true -}}
    {{- /* Resource hints for better performance */ -}}
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="https://tile.openstreetmap.org">
    {{- /* Leaflet CSS and JS */ -}}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha512-Zcn6bjR/8RZbLEpLIeOwNtzREBAJnUKESxces60Mpoj+2okopSAcSUIUOseddDm0cxnGQzxIR7vJgsLZbdLE3w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha512-BwHfrr4c9kmRkLw6iXFdzcdWV/PGkVgiIyIWLLlTSXzWQzxuSg4DiQUCpauz/EWjgk5TYQqX/kvn9pG1NpYfqg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-gpx@1.7.0/gpx.min.js" integrity="sha512-/yPV78iMZW2vseexUfxggYuVB4fzq40fsDVwz3tWOl9cb8MvCnmMCOjze1omsEj+APUuwZgnpcv5NR5q363JBA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="{{ "tours/tour-maps.js" | relURL }}" defer></script>
  {{- end -}}
{{- end -}}

{{- /* Load CSS once per page */ -}}
{{- if and (not $isFeedOutput) (not ($.Page.Scratch.Get "tour-styles-loaded")) -}}
  {{- $.Page.Scratch.Set "tour-styles-loaded" true -}}
  <link rel="stylesheet" href="{{ "tours/tour-styles.css" | relURL }}">
{{- end -}}

{{- /* Feed output (compact table) */ -}}
{{- if $isFeedOutput -}}
<table style="width: 100%; border-collapse: collapse; margin: 0 0 1rem; font-size: 0.95rem;">
  <tr>
    <td style="padding: 0.35rem 0.5rem; border: 1px solid #e0e0e0; width: 42%; vertical-align: top;">
      {{- if $title -}}
      <div style="font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem;">{{ $title | htmlEscape }}</div>
      {{- end -}}
      {{- if or $typeLabel $region -}}
      <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.35rem;">
        {{- if $typeLabel -}}<strong>{{ $typeLabel | htmlEscape }}</strong>{{- end -}}
        {{- if and $typeLabel $region }} Â· {{ end -}}
        {{- if $region -}}{{ $region | htmlEscape }}{{- end -}}
      </div>
      {{- end -}}
      {{- if $gpx -}}
      <div style="font-size: 0.85rem;">
        <a href="{{ $gpx | htmlEscape }}">ðŸ“¥ GPX herunterladen</a>
      </div>
      {{- end -}}
    </td>
    <td style="padding: 0.35rem 0.5rem; border: 1px solid #e0e0e0; vertical-align: top;">
      {{- if or (gt $distanceKm 0) (gt $elevationM 0) (gt $durationH 0) (gt $maxHeight 0) -}}
      <ul style="list-style: none; padding: 0; margin: 0;">
        {{- if gt $distanceKm 0 -}}
        <li style="margin: 0.15rem 0;"><strong>Distanz:</strong> {{ $distanceKm | htmlEscape }} km</li>
        {{- end -}}
        {{- if gt $elevationM 0 -}}
        <li style="margin: 0.15rem 0;"><strong>Aufstieg:</strong> {{ $elevationM | htmlEscape }} m</li>
        {{- end -}}
        {{- if gt $maxHeight 0 -}}
        <li style="margin: 0.15rem 0;"><strong>Max. HÃ¶he:</strong> {{ $maxHeight | htmlEscape }} m</li>
        {{- end -}}
        {{- if gt $durationH 0 -}}
        <li style="margin: 0.15rem 0;"><strong>Dauer:</strong> {{ $durationH | htmlEscape }} h</li>
        {{- end -}}
      </ul>
      {{- end -}}
    </td>
  </tr>
  {{- if $hasPeaks -}}
  <tr>
    <td colspan="2" style="padding: 0.35rem 0.5rem; border: 1px solid #e0e0e0; border-top: none; vertical-align: top;">
      <strong>Gipfelbuch:</strong>
      <ol style="margin: 0.25rem 0 0; padding-left: 1.25rem;">
        {{- range $peaksList -}}
        <li style="margin: 0.15rem 0;">{{ .label | htmlEscape }}</li>
        {{- end -}}
      </ol>
    </td>
  </tr>
  {{- end -}}
</table>
{{- else -}}
{{- /* Regular HTML output */ -}}
<section class="tour-entry" id="tour-{{ $id | htmlEscape }}">
  <header>
    <p class="tour-entry-meta">
      {{- if $typeLabel -}}
      <span class="tour-entry-meta-label">{{ $typeLabel | htmlEscape }}</span>
      {{- end -}}
      {{- if and $typeLabel $region -}}
      <span aria-hidden="true">, </span>
      {{- end -}}
      {{- if $region -}}
      <span class="tour-entry-meta-label">{{ $region | htmlEscape }}</span>
      {{- end -}}
    </p>
    <h3>{{ $title | htmlEscape }}</h3>
  </header>

  {{- if $shouldRenderMap -}}
  <div class="tour-map" data-tour-map data-gpx="{{ $gpx | htmlEscape }}"{{ if $peaksDataJSON }} data-peaks='{{ $peaksDataJSON | safeHTMLAttr }}'{{ end }} style="min-height:320px; margin:0.1625rem 0 0.75rem;"></div>
  {{- else if $coverImage -}}
  <figure class="tour-image">
    <img src="{{ $coverImage | htmlEscape }}" alt="{{ $title | htmlEscape }}" loading="lazy" />
  </figure>
  {{- end -}}

  <dl class="tour-stats-grid">
    {{- if gt $distanceKm 0 -}}
    <div class="tour-stat-card">
      <dt>Distanz</dt>
      <dd>
        <span class="tour-stat-value">{{ $distanceKm | htmlEscape }}</span>
        <span class="tour-stat-unit">km</span>
      </dd>
    </div>
    {{- end -}}
    {{- if gt $elevationM 0 -}}
    <div class="tour-stat-card">
      <dt>Aufstieg</dt>
      <dd>
        <span class="tour-stat-value">{{ $elevationM | htmlEscape }}</span>
        <span class="tour-stat-unit">m</span>
      </dd>
    </div>
    {{- end -}}
    {{- if gt $maxHeight 0 -}}
    <div class="tour-stat-card">
      <dt>Max. HÃ¶he</dt>
      <dd>
        <span class="tour-stat-value">{{ $maxHeight | htmlEscape }}</span>
        <span class="tour-stat-unit">m</span>
      </dd>
    </div>
    {{- end -}}
    {{- if gt $durationH 0 -}}
    <div class="tour-stat-card">
      <dt>Dauer</dt>
      <dd>
        <span class="tour-stat-value">{{ $durationH | htmlEscape }}</span>
        <span class="tour-stat-unit">h</span>
      </dd>
    </div>
    {{- end -}}
  </dl>

  {{- if $hasPeaks -}}
  <section>
    <h4>Gipfelbuch</h4>
    <ol class="gipfelbuch-list">
      {{- range $peaksList -}}
      <li>{{ .label | htmlEscape }}</li>
      {{- end -}}
    </ol>
    {{- if $gpx -}}
    <div class="gpx-download-link">
      <a href="{{ $gpx | htmlEscape }}" download>Download GPX</a>
    </div>
    {{- end -}}
  </section>
  {{- else if $gpx -}}
  <section>
    <div class="gpx-download-link">
      <a href="{{ $gpx | htmlEscape }}" download>Download GPX</a>
    </div>
  </section>
  {{- end -}}
</section>
{{- end -}}
